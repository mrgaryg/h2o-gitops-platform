apiVersion: scanning.apps.tanzu.vmware.com/v1beta1
kind: ScanPolicy
metadata:
  name: where-for-dinner-image-scan-policy
  namespace: where-for-dinner
  labels:
    app.kubernetes.io/part-of: scan-system
spec:
  regoFile: "package main\n\n# Accepted Values: \"Critical\", \"High\", \"Medium\", \"Low\", \"Negligible\", \"UnknownSeverity\"\nnotAllowedSeverities := [\"Critical\",\"High\",\"UnknownSeverity\"]\n\n# List of acceptable risks.  Must specify the rationale, subjective risk level, and expiration date.  Example:\n# {\n#   \"cve\": \"GHSA-36p3-wjmg-h94x\",\n#   \"rationale\": \"CVE is for spring-boot versions < 2.6.6.  We are running 2.7.3.  However grype scanner can not read derived versions from POM files, so it can't determine the package version and is reporting vulnerable.  This is limitation of grype with java POM.\"\n# }\nfalsePositiveCves := [\n]\n\n# List of acceptable risks.  Must specify the rationale, subjective risk level, and expiration date.  Example:\n# {\n#   \"cve\": \"CVE-2016-1000027\",\n#   \"rationale\": \"The hello application source has been reviewed and code paths analyzed.  Spring team does not intend to change this and disputes its rating.  Security team has agreed to ignore. https://nvd.nist.gov/vuln/detail/CVE-2016-1000027\",\n#   \"subjectiveRiskLevel\": \"Low\",\n#   \"expiration\": \"2022-Dec-31\"\n# }\nacceptableRiskCves := [\n  {\n    \"cve\": \"CVE-2024-20918\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Low\",\n    \"expiration\": \"2025-Jan-31\"\n  },\n  {\n    \"cve\": \"CVE-2024-20952\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Low\",\n    \"expiration\": \"2025-Jan-31\"\n  },\n  {\n    \"cve\": \"GHSA-9763-4f94-gfch\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Low\",\n    \"expiration\": \"2025-Jan-31\"\n  },\n  {\n    \"cve\": \"GHSA-449p-3h89-pw88\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Low\",\n    \"expiration\": \"2025-Jan-31\"\n  },\n  {\n    \"cve\": \"GHSA-mw99-9chc-xw7r\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Low\",\n    \"expiration\": \"2025-Jan-31\"\n  },\n  {\n    \"cve\": \"GHSA-vmq6-5m68-f53m\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Low\",\n    \"expiration\": \"2025-Jan-31\"\n  },\n  {\n    \"cve\": \"GHSA-xpw8-rcwv-8f8p\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Low\",\n    \"expiration\": \"2025-Jan-31\"\n  },\n  {\n    \"cve\": \"CVE-2023-44487\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Low\",\n    \"expiration\": \"2025-Jan-31\"\n  },\n  {\n    \"cve\": \"CVE-2023-21930\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Low\",\n    \"expiration\": \"2024-Jan-31\"\n  },\n  {\n    \"cve\": \"CVE-2019-20444\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2019-20445\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2016-1000027\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2016-1000027\",\n    \"rationale\": \"The hello application source has been reviewed and code paths analyzed.  Spring team does not intend to change this and disputes its rating.  Security team has agreed to ignore. https://nvd.nist.gov/vuln/detail/CVE-2016-1000027\",\n    \"subjectiveRiskLevel\": \"Low\",\n    \"expiration\": \"2024-Dec-31\"\n  },\n  {\n    \"cve\": \"GHSA-w573-4hg7-7wgq\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2023-20860\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2019-20444\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2019-20444\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2019-20445\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"GHSA-mjmj-j48q-9wg2\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"GHSA-vvpx-j8f3-3w6h\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2015-2156\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2019-16869\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2021-37136\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2021-37137\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2022-41881\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"GHSA-493p-pfq6-5258\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2022-45868\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"GHSA-22wj-vf5f-wrvj\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2023-24998\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"GHSA-hfrx-6qgj-fp6c\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2018-25076\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2022-37601\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"GHSA-76p3-8jx3-jpfq\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2022-43604\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2022-43605\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2017-18589\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"GHSA-9c47-m6qq-7p4h\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2022-37599\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2022-37603\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"GHSA-3rfm-jhwj-7488\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"GHSA-hhq3-ff78-jv3g\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"GHSA-f8q6-p94x-37v3\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2021-3803\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"GHSA-rp65-9cf3-cjxr\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"GHSA-hc6q-2mpp-qw7j\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"GHSA-rc47-6667-2j5j\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2020-1416\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2022-38900\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2023-23918\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2023-23919\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2021-27478\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2021-27482\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },      \n  {\n    \"cve\": \"CVE-2021-27498\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2021-27500\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2022-43606\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2021-20066\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2002-1647\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2020-13844\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2022-3821\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2022-48303\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2023-23920\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2023-23936\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2013-1779\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2016-2781\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2022-3219\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2009-5155\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2015-8985\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2016-20013\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2019-17594\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2019-17595\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2023-4911\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"GHSA-67hx-6x53-jw92\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2023-32002\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2023-32006\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2023-32559\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"CVE-2015-5237\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  },\n  {\n    \"cve\": \"GHSA-2jcg-qqmg-46q6\",\n    \"rationale\": \"I don't know how to fix and this is a demo app.\",\n    \"subjectiveRiskLevel\": \"Unknown\",\n    \"expiration\": \"2024-Feb-28\"\n  }\n]\n\ncontains(arr1, elem) = true {\n  arr1[_] = elem\n} else = false { true }\n\nfoundInFalsePositiveList(arr2, elem) = true {\n  arr2[_].cve = elem\n} else = false { true }\n\nfoundInAcceptableRiskList(array, elem) = true {\n  array[_].cve = elem\n  curr_time := time.now_ns()\n  date_format := \"2006-Jan-02\"\n  expire_time := time.parse_ns(date_format, array[_].expiration)\n  curr_time < expire_time\n} else = false { true }\n\n# Custom Acceptable Risk Rule.  Report safe if found in acceptabile risk list and accepted risk is not expired\nisSafe(match) {\n  ignore := foundInAcceptableRiskList(acceptableRiskCves, match.id)\n  ignore\n}\n\n# Custom False Positive rule.  Report safe if found in false positive list\nisSafe(match) {\n  ignore := foundInFalsePositiveList(falsePositiveCves, match.id)\n  ignore\n}\n\n# OOTB Safe if severity is in severity allow list\nisSafe(match) {\n  severities := { e | e := match.ratings.rating.severity } | { e | e := match.ratings.rating[_].severity }\n  some i\n  fails := contains(notAllowedSeverities, severities[i])\n  not fails\n}\n\ndeny[msg] {\n  comps := { e | e := input.bom.components.component } | { e | e := input.bom.components.component[_] }\n  some i\n  comp := comps[i]\n  vulns := { e | e := comp.vulnerabilities.vulnerability } | { e | e := comp.vulnerabilities.vulnerability[_] }\n  some j\n  vuln := vulns[j]\n  ratings := { e | e := vuln.ratings.rating.severity } | { e | e := vuln.ratings.rating[_].severity }\n  not isSafe(vuln)\n  msg = sprintf(\"CVE %s %s %s\", [comp.name, vuln.id, ratings])\n}"
